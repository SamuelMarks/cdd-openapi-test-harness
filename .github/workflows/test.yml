name: cdd-openapi-test-harness

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  angular-integration:
    runs-on: ubuntu-latest
    services:
      petstore_server:
        image: swaggerapi/petstore
        ports:
          - "8080:8080"
        env:
          SWAGGER_HOST: "http://localhost:8080"
          SWAGGER_BASE_PATH: "/v2"

    steps:
      - name: Checkout repo and submodules
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: 'cdd-web-ng/package-lock.json'

      - name: Install dependencies and build cdd-web-ng
        working-directory: cdd-web-ng
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm i
          fi
          npm run build
          cd ..
          npx -p @angular/cli ng new angular-client --defaults --skip-git
          cd angular-client
          npx ng add @angular/material --skip-confirmation
          cd ../cdd-web-ng
          node dist/cli.js from_openapi -i ../petstore.json --output ../angular-client/src/app/api

      - name: Install dependencies and run tests for Angular client
        working-directory: angular-client
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm i
          fi
          npm run test -- --watch=false

  kotlin-integration:
    runs-on: ubuntu-latest
    services:
      petstore_server:
        image: swaggerapi/petstore
        ports:
          - "8080:8080"
        env:
          SWAGGER_HOST: "http://localhost:8080"
          SWAGGER_BASE_PATH: "/v2"
    steps:
      - name: Checkout repo and submodules
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version: '21'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Build and Run Kotlin Generator
        working-directory: cdd-kotlin
        run: |
          ./gradlew run --args="from_openapi -i ../petstore.json --clientName MyGeneratedClient --output ../kotlin-client --dateType string"

      - name: Copy Kotlin Integration Tests
        run: |
          mkdir -p kotlin-client/composeApp/src/commonTest/kotlin/com/example/auto
          cp cdd-kotlin/tests/integration/kotlin-integration.kt kotlin-client/composeApp/src/commonTest/kotlin/com/example/auto/IntegrationTest.kt

      - name: Test Kotlin Client
        working-directory: kotlin-client
        run: ./gradlew test

  go-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo and submodules
        uses: actions/checkout@v6
        with:
          submodules: recursive
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'
          cache: true
      - name: Run Go Tests
        working-directory: cdd-go
        run: go test -v -coverprofile=coverage.out ./...

  csharp-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo and submodules
        uses: actions/checkout@v6
        with:
          submodules: recursive
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '10.0.x'
      - name: Build and Test C#
        working-directory: cdd-csharp
        run: |
          dotnet restore
          dotnet build --no-restore
          dotnet test tests/Cdd.OpenApi.Tests --no-build

  sh-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo and submodules
        uses: actions/checkout@v6
        with:
          submodules: recursive
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl shellcheck
      - name: Run Test Suite
        working-directory: cdd-sh
        run: ./test.sh
      - name: Verify Shellcheck
        working-directory: cdd-sh
        run: shellcheck cdd.sh src/*/*.sh
